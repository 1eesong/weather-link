<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>친구 기능 테스트 (수락/거절 포함)</title>
  <style>
    body { font-family: 'Segoe UI', sans-serif; margin: 2rem; background: #f4f6fb; }
    h1 { margin-bottom: 2rem; }
    .section { margin-bottom: 2.5rem; }
    .search-bar { display: flex; gap: 0.5rem; margin-bottom: 1rem; }
    input { flex: 1; padding: 0.5rem 1rem; border-radius: 20px; border: 1px solid #ccc; }
    button { padding: 0.5rem 1.5rem; border-radius: 20px; border: none; background: #34b7f1; color: #fff; font-weight: bold; cursor: pointer; }
    .user-list { display: flex; flex-direction: column; gap: 1rem; }
    .user-card {
      display: flex; align-items: center; background: #fff; border-radius: 14px;
      box-shadow: 0 2px 8px #e1e1e1; padding: 1rem 1.5rem; transition: box-shadow 0.2s;
    }
    .user-card:hover { box-shadow: 0 4px 16px #d0d0d0; }
    .user-img {
      width: 56px; height: 56px; border-radius: 50%; object-fit: cover; margin-right: 1.25rem; background: #f0f0f0;
      border: 2px solid #e3e3e3;
    }
    .user-info { flex: 1; }
    .user-name { font-weight: bold; font-size: 1.15rem; }
    .user-meta { font-size: 0.95rem; color: #888; }
    .user-status { font-size: 0.95rem; color: #4a90e2; margin-top: 2px; }
    .add-btn, .accept-btn, .reject-btn {
      padding: 0.5rem 1.2rem; border: none; border-radius: 20px; font-weight: bold; font-size: 1rem; margin-left: 0.5rem;
      transition: background 0.2s;
    }
    .add-btn { background: #34b7f1; color: #fff; }
    .add-btn[disabled] { background: #b2b2b2; cursor: default; }
    .add-btn.friend { background: #3cb371; }
    .add-btn.pending { background: #ffb400; }
    .accept-btn { background: #3cb371; color: #fff; }
    .reject-btn { background: #e94f4f; color: #fff; }
    .no-result { color: #888; text-align: center; margin-top: 2rem; }
    .card-actions { display: flex; gap: 0.5rem; }
    .section-title { margin-bottom: 0.5rem; font-size: 1.1rem; font-weight: bold; }
  </style>
</head>
<body>
  <h1>친구 기능 테스트</h1>

  <!-- 친구 검색/추가 -->
  <div class="section">
    <div class="section-title">친구 검색</div>
    <div class="search-bar">
      <input type="text" id="searchName" placeholder="닉네임 입력" />
      <button id="searchBtn">검색</button>
    </div>
    <div id="searchResults" class="user-list"></div>
    <div id="searchLoading" style="display:none; text-align:center; color:#888;">검색 중...</div>
    <div id="noResult" class="no-result" style="display:none;">검색 결과가 없습니다.</div>
  </div>

  <!-- 받은 친구 요청 목록 -->
  <div class="section">
    <div class="section-title">받은 친구 요청</div>
    <button onclick="loadReceivedRequests()" style="margin-bottom:0.7rem;">새로고침</button>
    <div id="receivedRequests" class="user-list"></div>
    <div id="receivedLoading" style="display:none; text-align:center; color:#888;">불러오는 중...</div>
    <div id="receivedNone" class="no-result" style="display:none;">받은 친구 요청이 없습니다.</div>
  </div>

  <!-- 친구 목록 섹션 -->
<div class="section">
  <div class="section-title">내 친구 목록</div>
  <button onclick="loadFriendsList()" style="margin-bottom:0.7rem;">새로고침</button>
  <div id="friendsList" class="user-list"></div>
  <div id="friendsLoading" style="display:none; text-align:center; color:#888;">불러오는 중...</div>
  <div id="friendsNone" class="no-result" style="display:none;">친구가 없습니다.</div>
</div>

  <script>
    // 친구 목록 불러오기
    async function loadFriendsList() {
      document.getElementById('friendsList').innerHTML = '';
      document.getElementById('friendsLoading').style.display = '';
      document.getElementById('friendsNone').style.display = 'none';

      try {
        const res = await fetch(`http://localhost:3000/api/v1/friends`, {
          headers: { 'Authorization': `Bearer ${JWT_TOKEN}` }
        });
        const json = await res.json();
        const friends = json.data?.data || [];
        if (friends.length === 0) {
          document.getElementById('friendsNone').style.display = '';
        }
        renderFriendsList(friends);
      } catch (e) {
        alert('친구 목록 불러오기 오류');
      } finally {
        document.getElementById('friendsLoading').style.display = 'none';
      }
    }

    // 친구 목록 렌더링
    function renderFriendsList(friends) {
      const list = document.getElementById('friendsList');
      list.innerHTML = '';
      friends.forEach(user => {
        const card = document.createElement('div');
        card.className = 'user-card';
        card.innerHTML = `
            <img class="user-img" src="${user.profileImage}" alt="프로필">
            <div class="user-info">
                <div class="user-name">${user.name}</div>
                ${
                user.location && user.location.sido && user.location.gugun
                    ? `<div class="user-meta">${user.location.sido} ${user.location.gugun}</div>`
                    : ''
                }
                ${user.statusMessage ? `<div class="user-status">${user.statusMessage}</div>` : ''}
            </div>
        `;
        list.appendChild(card);
      });
    }

    // 페이지 진입 시 친구 목록 자동 로드
    window.addEventListener('DOMContentLoaded', loadFriendsList);
  </script>


  <script>
    // 실제 JWT 토큰 입력 필요
    // const JWT_TOKEN = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0MkB0ZXN0LmNvbSIsImlhdCI6MTc0NTgwNzEwOCwiZXhwIjoxNzQ1ODEwNzA4fQ.fca8n84H5fJkXzzdckd2O9HQYoNsBlWfbS8NuE-ugrY';
    const JWT_TOKEN = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0QHRlc3QuY29tIiwiaWF0IjoxNzQ1ODA0OTI3LCJleHAiOjE3NDU4MDg1Mjd9.sazUIOS2QhJfAgQaZkFMX7zB1NgapV3EKQKLahEgyB8';
    // 내 유저 ID (로그인 후 받아와야 함)
    const MY_USER_ID = '';

    // API 기본 URL
    const API_BASE = 'http://localhost:3000/api/v1/friends';

    // relationStatus 캐시 (id: {status: 'none'|'pending'|'friend'})
    const relationStatus = {};

    // --- 친구 검색 ---
    document.getElementById('searchBtn').onclick = searchUsers;
    document.getElementById('searchName').addEventListener('keydown', e => {
      if (e.key === 'Enter') searchUsers();
    });

    async function searchUsers() {
      const name = document.getElementById('searchName').value.trim();
      if (!name) return alert('닉네임을 입력하세요.');
      document.getElementById('searchResults').innerHTML = '';
      document.getElementById('searchLoading').style.display = '';
      document.getElementById('noResult').style.display = 'none';

      try {
        const res = await fetch(`${API_BASE}/search?name=${encodeURIComponent(name)}`, {
          headers: { 'Authorization': `Bearer ${JWT_TOKEN}` }
        });
        const json = await res.json();
        const users = json.data?.data || [];
        if (users.length === 0) {
          document.getElementById('noResult').style.display = '';
        }
        renderSearchResults(users);
      } catch (e) {
        alert('검색 중 오류 발생');
      } finally {
        document.getElementById('searchLoading').style.display = 'none';
      }
    }

    function renderSearchResults(users) {
      const list = document.getElementById('searchResults');
      list.innerHTML = '';
      users.forEach(user => {
        const card = document.createElement('div');
        card.className = 'user-card';

        card.innerHTML = `
            <img class="user-img" src="${user.profileImage}" alt="프로필">
            <div class="user-info">
                <div class="user-name">${user.name}</div>
                ${
                user.location && user.location.sido && user.location.gugun
                    ? `<div class="user-meta">${user.location.sido} ${user.location.gugun}</div>`
                    : ''
                }
                ${user.statusMessage ? `<div class="user-status">${user.statusMessage}</div>` : ''}
            </div>
        `;


        // 친구 추가 버튼
        const btn = document.createElement('button');
        btn.className = 'add-btn';
        btn.textContent = '친구 추가';
        btn.onclick = () => sendFriendRequest(user.id, btn);

        setButtonState(btn, user);

        card.appendChild(btn);
        list.appendChild(card);
      });
    }

    function setButtonState(btn, user) {
      const status = relationStatus[user.id] || 'none';
      if (user.id === MY_USER_ID) {
        btn.textContent = '나';
        btn.disabled = true;
        btn.className = 'add-btn friend';
      } else if (status === 'friend') {
        btn.textContent = '친구';
        btn.disabled = true;
        btn.className = 'add-btn friend';
      } else if (status === 'pending') {
        btn.textContent = '요청됨';
        btn.disabled = true;
        btn.className = 'add-btn pending';
      } else {
        btn.textContent = '친구 추가';
        btn.disabled = false;
        btn.className = 'add-btn';
      }
    }

    async function sendFriendRequest(receiverId, btn) {
      btn.disabled = true;
      btn.textContent = '요청중...';
      try {
        const res = await fetch(`${API_BASE}/request`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${JWT_TOKEN}`
          },
          body: JSON.stringify({ receiverId })
        });
        if (res.ok) {
          relationStatus[receiverId] = 'pending';
          btn.textContent = '요청됨';
          btn.className = 'add-btn pending';
        } else {
          const err = await res.json();
          if (err.message && err.message.includes('이미 친구')) {
            relationStatus[receiverId] = 'friend';
            btn.textContent = '친구';
            btn.className = 'add-btn friend';
          } else if (err.message && err.message.includes('이미 친구 요청')) {
            relationStatus[receiverId] = 'pending';
            btn.textContent = '요청됨';
            btn.className = 'add-btn pending';
          } else {
            btn.textContent = '실패';
            btn.className = 'add-btn pending';
            setTimeout(() => setButtonState(btn, {id: receiverId}), 1500);
          }
        }
      } catch (e) {
        btn.textContent = '실패';
        btn.className = 'add-btn pending';
        setTimeout(() => setButtonState(btn, {id: receiverId}), 1500);
      }
    }

    // --- 받은 친구 요청 목록 ---
    async function loadReceivedRequests() {
      document.getElementById('receivedRequests').innerHTML = '';
      document.getElementById('receivedLoading').style.display = '';
      document.getElementById('receivedNone').style.display = 'none';

      try {
        const res = await fetch(`${API_BASE}/requests/received`, {
          headers: { 'Authorization': `Bearer ${JWT_TOKEN}` }
        });
        const json = await res.json();
        const requests = json.data || [];
        if (requests.length === 0) {
          document.getElementById('receivedNone').style.display = '';
        }
        renderReceivedRequests(requests);
      } catch (e) {
        alert('받은 요청 불러오기 오류');
      } finally {
        document.getElementById('receivedLoading').style.display = 'none';
      }
    }

    function renderReceivedRequests(requests) {
      const list = document.getElementById('receivedRequests');
      list.innerHTML = '';
      requests.forEach(req => {
        const user = req.sender || {};
        const card = document.createElement('div');
        card.className = 'user-card';
        card.innerHTML = `
            <img class="user-img" src="${user.profileImage}" alt="프로필">
            <div class="user-info">
                <div class="user-name">${user.name}</div>
                ${
                user.location && user.location.sido && user.location.gugun
                    ? `<div class="user-meta">${user.location.sido} ${user.location.gugun}</div>`
                    : ''
                }
                ${user.statusMessage ? `<div class="user-status">${user.statusMessage}</div>` : ''}
            </div>
        `;
        // 수락/거절 버튼
        const actions = document.createElement('div');
        actions.className = 'card-actions';
        const acceptBtn = document.createElement('button');
        acceptBtn.className = 'accept-btn';
        acceptBtn.textContent = '수락';
        acceptBtn.onclick = () => respondRequest(req.id, true, card);

        const rejectBtn = document.createElement('button');
        rejectBtn.className = 'reject-btn';
        rejectBtn.textContent = '거절';
        rejectBtn.onclick = () => respondRequest(req.id, false, card);

        actions.appendChild(acceptBtn);
        actions.appendChild(rejectBtn);
        card.appendChild(actions);

        list.appendChild(card);
      });
    }

    // 친구 요청 수락/거절
    async function respondRequest(requestId, accept, cardElem) {
      // 버튼 비활성화
      const btns = cardElem.querySelectorAll('button');
      btns.forEach(btn => btn.disabled = true);
      try {
        const res = await fetch(`${API_BASE}/respond`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${JWT_TOKEN}`
          },
          body: JSON.stringify({ requestId, accept })
        });
        if (res.ok) {
          cardElem.style.opacity = 0.4;
          cardElem.querySelector('.card-actions').innerHTML = accept ? '<span style="color:#3cb371;">수락됨</span>' : '<span style="color:#e94f4f;">거절됨</span>';
        } else {
          alert('처리 실패');
          btns.forEach(btn => btn.disabled = false);
        }
      } catch (e) {
        alert('처리 중 오류');
        btns.forEach(btn => btn.disabled = false);
      }
    }

    // 페이지 진입 시 받은 친구 요청 자동 로드
    window.addEventListener('DOMContentLoaded', loadReceivedRequests);
  </script>
</body>
</html>
